name: Download and install the HTTP certificate for the portal + the web admin
version: 2
testcases:
- name: create_temp_directory
  steps:
    - type: exec
      script: "mktemp -d"
      vars:
        temp_dir:
          from: result.systemout

- name: download_p12_file
  steps:
  - type: exec
    script: "curl -k --output {{.create_temp_directory.temp_dir}}/{{.dot1x_eap_tls_pfpki.cert.http}}.p12 http://127.0.0.1:22225/api/v1/pki/cert/4/download/secret"

- name: extract_certificates
  steps:
  - type: exec
    script: "openssl pkcs12 -in {{.create_temp_directory.temp_dir}}/{{.dot1x_eap_tls_pfpki.cert.http}}.p12 -nokeys -out {{.create_temp_directory.temp_dir}}/{{.dot1x_eap_tls_pfpki.cert.http}}.crt -passin pass:secret"

- name: extract_private_key
  steps:
  - type: exec
    script: "openssl pkcs12 -in {{.create_temp_directory.temp_dir}}/{{.dot1x_eap_tls_pfpki.cert.http}}.p12 -nocerts -nodes -out {{.create_temp_directory.temp_dir}}/{{.dot1x_eap_tls_pfpki.cert.http}}.key -passin pass:secret"

- name: install_http_cert_portal
  steps:
  - type: exec
    script: "cat {{.create_temp_directory.temp_dir}}/{{.dot1x_eap_tls_pfpki.cert.http}}.crt {{.create_temp_directory.temp_dir}}/{{.dot1x_eap_tls_pfpki.cert.http}}.key > /usr/local/pf/conf/ssl/server.pem"

- name: install_http_cert_webadmin
  steps:
  - type: exec
    script: "cat {{.create_temp_directory.temp_dir}}/{{.dot1x_eap_tls_pfpki.cert.http}}.crt > /usr/local/pf/conf/ssl/server.crt"

- name: install_http_key_webadmin
  steps:
  - type: exec
    script: "cat {{.create_temp_directory.temp_dir}}/{{.dot1x_eap_tls_pfpki.cert.http}}.key > /usr/local/pf/conf/ssl/server.key"
