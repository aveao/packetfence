// to display images directly on GitHub
ifdef::env-github[]
:encoding: UTF-8
:lang: en
:doctype: book
:toc: left
:imagesdir: ../images
endif::[]

////

    This file is part of the PacketFence project.

    See PacketFence_Network_Devices_Configuration_Guide-docinfo.xml for 
    authors, copyright and license information.

////

//== Wireless Controllers and Access Point Configuration


=== Assumptions

Throughout this configuration example we use the following assumptions for our network infrastructure:

[options="compact"]
* PacketFence is fully configured with FreeRADIUS running
* PacketFence IP address: 192.168.1.5
* Normal VLAN: 1
* Registration VLAN: 2
* Isolation VLAN: 3
* MAC Detection VLAN: 4
* Guest VLAN: 5
* VoIP, Voice VLAN: 100
* use SNMP v2c
* SNMP community name: public
* RADIUS Secret: useStrongerSecret footnote:[Be careful to change the secret key to a much stronger one. A 16 character random secret with digits, upper case and lower case characters is recommended.]
* Open SSID: PacketFence-Public
* WPA-Enterprise SSID: PacketFence-Secure


=== Unsupported Equipment

Wireless network access configuration is a lot more consistent between vendors. This is due to the fact that the situation is a lot more standardized than the wired side: VLAN assignment is done centrally with RADIUS and that the client protocol is consistent (MAC-Authentication or 802.1X).

This consistency has the benefit that a lot of the wireless network devices tend to work out-of-the-box with PacketFence. The only missing piece being, in most cases, remote deauthentication of the client which is used for VLAN assignment (deauth user so it'll reconnect and get new VLAN).

So, even if your wireless equipment is not explicitly supported by PacketFence, it's recommended that you give it a try. The next section covers the objectives that you want to accomplish for trying out your equipment even if we don't have configuration for it.

Here are the high-level requirements for proper wireless integration with PacketFence

* The appropriate VLANs must exist
* Allow controller to honor VLAN assignments from AAA (sometimes called AAA override)
* Put your open SSID (if any) in MAC-Authentication mode and authenticate against the FreeRADIUS hosted on PacketFence
* Put your secure SSID (if any) in 802.1X mode and authenticate against FreeRADIUS hosted on PacketFence.
* On registration / isolation VLANs the DHCP traffic must reach the PacketFence server
* On your production VLANs a copy of the DHCP traffic must reach PacketFence where a pfdhcplistener listens (configurable in `pf.conf` under `interfaces`)

At this point, user registration with the captive-portal is possible and registered users should have access to the appropriate VLANs. However, VLAN changes (like after a registration) won't automatically happen, you will need to disconnect / reconnect. An explanation is provided in introduction section above about this behavior.

You can try modules similar to your equipment if any (read appropriate instructions) or you can try to see if RFC3576 is supported. RFC3576 covers RADIUS Packet of Disconnect (PoD) also known as Disconnect Messages (DM) or Change of Authorization (CoA). You can try the Aruba module if you want to verify if RFC3576 is supported by your hardware.

If none of the above worked then you can fallback to inline enforcement or let us know what equipment you are using on the https://lists.sourceforge.net/lists/listinfo/packetfence-devel[packetfence-devel mailing list].

=== Aerohive Networks

include::networkdevice/aerohive.asciidoc[]

[float]
===== Roles (User Profiles)

Since PacketFence 3.3.0, we now support user profiles on the AeroHIVE hardware.  To build a User Profile, go to _Configuration -> User Profiles_, and create what you need.  When you define the switch
definition in PacketFence, the role will match the User Profile attribute number.  Example

   roles=CategoryStudent=1;CategoryStaff=2

And in the AeroHIVE configuration, you have :

   StudentProfile attribute number 1
   StaffProfile attribute number 2

Last step is to allow the User Profile to be returned for a particular SSID.  Go to _Configuration -> SSIDs -> Your_SSID -> User Profiles_ for Traffic Management*, and select the User Profiles you will
return for the devices.

In version 6 or later of the HiveOS, we do return VLAN ID matching the number that the *User Profile* has. Create your *User Profile* in the HiveManager as usual, assign the matching VLAN, and in PacketFence configuration add the wanted VLAN ID in the section *Roles by VLAN*.

=== Anyfi Networks

include::networkdevice/anyfi.asciidoc[]

=== Avaya

==== Wireless Controller


NOTE: To be contributed....

=== Aruba

==== All Aruba OS

In this section, we cover the basic configuration of the Aruba wireless controller for PacketFence via the web GUI. It was done on an Aruba Controller 200 software version ArubaOS 5.0.3.3, tested on a Controller 600 with ArubaOS 6.0 but it should apply to all Aruba models.

CAUTION: If you are already using your Aruba controllers and don't want to impact your users you should create new AAA profiles and apply them to new SSIDs instead of modifying the default ones.

NOTE: Starting with PacketFence 3.3, Aruba supports role-based access control. Read the Administration Guide under "Role-based enforcement support" for more information about how to configure it on the PacketFence side.

[float]
===== AAA Settings

In the Web interface, go to _Configuration -> Authentication -> RADIUS Server_ and add a RADIUS server named "packetfence" then edit it:

* Set Host to PacketFence's IP (192.168.1.5)
* Set the Key to your RADIUS shared secret (useStrongerSecret)
* Click Apply

Under _Configuration -> Authentication -> Server Group_ add a new Server Group named "packetfence" then edit it to add your RADIUS Server "packetfence" to the group. Click Apply.

Under _Configuration -> Authentication -> RFC3576_ add a new server with PacketFence's IP (192.168.1.5) and your RADIUS shared secret (useStrongerSecret). Click Apply.
Under _Configuration -> Authentication -> L2 Authentication_ edit the MAC Authentication Profile called "default" then edit it to change the Delimiter to dash. Click Apply.

Under _Configuration -> Authentication -> L2 Authentication_ edit the 802.1X Authentication Profile called "default" then edit it to uncheck the Opportunistic Key Caching under Advanced. Click Apply.

Under _Configuration -> Authentication -> AAA Profiles_ click on the "default-mac-auth" profile then click on MAC Authentication Server Group and choose the "packetfence" server group. Click Apply. Move to the RFC3576 server sub item and choose PacketFence's IP (192.168.1.5) click add then apply.

Under _Configuration -> Authentication -> AAA Profiles_ click on the "default-dot1x" profile then click on 802.1X Authentication Server Group and choose the "packetfence" server group. Click Apply. Move to the RFC3576 server sub item and choose PacketFence's IP (192.168.1.5) click add then apply.

[float]
===== Public SSID

In the Web interface, go to _Configuration -> AP Configuration_ then edit the "default" AP Group. Go in _Wireless LAN -> Virtual AP_ create a new profile with the following:

* AAA Profile: default-mac-auth
* SSID Profile: Select NEW then add an SSID (PacketFence-Public) and Network authentication set to None

[float]
===== Secure SSID

In the Web interface, go to _Configuration -> AP Configuration_ then edit the "default" AP Group. Go in _Wireless LAN -> Virtual AP_ create a new profile with the following:

* AAA Profile: default-dot1x
* SSID Profile: Select NEW then add an SSID (PacketFence-Secure) and Network authentication set to WPA2

[float]
===== Roles

Since PacketFence 3.3.0, we now support roles for the Aruba hardware.  To add roles, go in _Configuration -> Access Control -> User Roles -> Add_.  You don't need to force a VLAN usage in the Role
since we send also the VLAN ID along with the Aruba User Role in the RADIUS request.  Refer to the Aruba User Guide for more information about the Role creation.

===== WIPS

In order to use the WIPS feature in PacketFence, please follow those simple steps to send the traps to PacketFence.

First, configure PacketFence to be a trap receiver.  Under _Configuration -> SNMP -> Trap Receivers_, add an entry for the PF management IP.  By default, all traps will be enabled.  If you want to disable some, you will need
to connect via CLI, and run the *snmp-server trap disable <trapname>* command.

===== WebAuth

First of all you will need to configure a guest VLAN.

image::aruba-create-guest-vlan.png[scaledwidth="100%",alt="Guest VLAN"]

Next, you will need to configure a RADIUS server.

image::aruba-radius-server.png[scaledwidth="100%",alt="RADIUS server"]

  aaa authentication-server radius "packetfence"
  host 192.168.1.5
  key useStrongerSecret

Add your RADIUS server to a AAA group, under _Security -> Authentication -> Servers -> Server Group_:

  aaa server-group "packetfence"
  auth-server "packetfence" position 1

Then define the `RFC 3576` server, which will allow you to do CoA.

image::aruba-config-coa.png[scaledwidth="100%",alt="RADIUS CoA server"]

  aaa rfc-3576-server "192.168.1.5"
  key useStrongerSecret

Next, you will need to create the policy that will redirect users to the PacketFence captive portal when they are not authenticated. Go to _Security -> Authentication -> L3 Authentication -> Captive Portal Authentication Profile_.

image::aruba-l3-auth1.png[scaledwidth="100%",alt="Layer 3 profile"]
image::aruba-l3-auth2.png[scaledwidth="100%",alt="Layer 3 profile 2"]

  aaa authentication captive-portal "packetfence-externalportal"
  default-role auth-guest
  redirect-pause 3
  no logout-popup-window
  login-page https://192.168.1.5/Aruba
  switchip-in-redirection-url

Now create the policy for the guest access, for example Internet only.

Add the authentication for the Captive Portal Profile via _Security -> Authentication -> L3 Authentication -> Captive Portal Authentication Profile -> Server Group_:

  aaa authentication captive-portal "packetfence-externalportal"
  server-group "packetfence"

Adjust the configuration of the AAA profile through _Security -> Authentication -> Profiles -> AAA Profiles_:

image::aruba-config-aaa-profile1.png[scaledwidth="30%",alt="AAA profile 1"]
image::aruba-config-aaa-profile2.png[scaledwidth="100%",alt="AAA profile 2"]
image::aruba-config-aaa-profile3.png[scaledwidth="100%",alt="AAA profile 3"]
image::aruba-config-aaa-profile4.png[scaledwidth="100%",alt="AAA profile 4"]
image::aruba-config-aaa-profile5.png[scaledwidth="100%",alt="AAA profile 5"]
image::aruba-config-aaa-profile6.png[scaledwidth="100%",alt="AAA profile 6"]

  aaa profile "packetfence-externalportal"
  initial-role packetfence-portal
  radius-interim-accounting
  radius-accounting "packetfence"
  rfc-3576-server "192.168.1.5"

Define a policy to permit the traffic.

First add a destination, _Advanced Services -> Stateful Firewall -> Destinations_:

  netdestination packetfence-portal
  host 192.168.1.5

Create an ACL for the redirection, _Security -> Firewall Policies_:

image::aruba-config-policy1.png[scaledwidth="100%",alt="Policy 1"]
image::aruba-config-policy2.png[scaledwidth="100%",alt="Policy 2"]
image::aruba-config-policy3.png[scaledwidth="100%",alt="Policy 3"]
image::aruba-config-policy4.png[scaledwidth="100%",alt="Policy 4"]
image::aruba-config-policy5.png[scaledwidth="100%",alt="Policy 5"]

Source NAT on VLAN

  ip access-list session "packetfence-externalportal"
  alias "user" alias "packetfence-portal" "svc-http" permit queue low
  alias "user" alias "packetfence-portal" "svc-https" permit queue low

Enable the "firewall allow-tri-session" :

  firewall allow-tri-session

Source NAT per Application

  ip access-list session "packetfence-externalportal"
  alias "user" alias "packetfence-portal" "svc-http" src-nat queue low
  alias "user" alias "packetfence-portal" "svc-https" src-nat queue low

Now add the newly created policy to the Captive Portal Profile, _Security -> User Roles_:

image::aruba-config-user-role.png[scaledwidth="100%",alt="User Role"]
image::aruba-interface-redirection.png[scaledwidth="100%",alt="Interface de redirection"]

  user-role "packetfence-portal"
  access-list session "packetfence-externalportal" position 1
  access-list session "captiveportal" position 2
  access-list session "guest-logon-access" position 3
  access-list session "block-internal-access" position 4
  access-list session "v6-logon-control" position 5
  access-list session "captiveportal6" position 6
  captive-portal "packetfence-externalportal"

Finaly create the SSID and associate the profile to it, `Virtual AP profile`:

  wlan virtual-ap "packetfence-externalportal"
  ssid-profile "packetfence-externalportal"
  aaa-profile "packetfence"

General AP settings and master-slave controller case.

image::aruba-ap-config1.png[scaledwidth="30%",alt="Config AP 1"]
image::aruba-ap-config2.png[scaledwidth="100%",alt="Config AP 2"]
image::aruba-ap-config3.png[scaledwidth="100%",alt="Config AP 3"]
image::aruba-ap-config4.png[scaledwidth="100%",alt="Config AP 4"]
image::aruba-ap-config5.png[scaledwidth="100%",alt="Config AP 5"]
image::aruba-ap-config6.png[scaledwidth="100%",alt="Config AP 6"]
image::aruba-ap-config7.png[scaledwidth="100%",alt="Config AP 7"]
image::aruba-ap-config8.png[scaledwidth="100%",alt="Config AP 8"]
image::aruba-ap-config9.png[scaledwidth="100%",alt="Config AP 9"]
image::aruba-ap-config10.png[scaledwidth="100%",alt="Config AP 10"]
image::aruba-ap-config11.png[scaledwidth="100%",alt="Config AP 11"]

image::aruba-secondary-controller.png[scaledwidth="100%",alt="Secondary controller configuration"]

The next step will be to configure the Aruba WiFi controller for WebAuth in PacketFence, add the switch with the model choice `Aruba Network`, 

image::aruba-wlc1.png[scaledwidth="80%",alt="Add Aruba wireless controller"]
image::aruba-wlc-roles.png[scaledwidth="80%",alt="Aruba wireless controller roles configuration"]

Check the box `External Portal Enforcement`, in the Roles section, choose `Role by Switch Role`, as the registration role, enter your default role: `packetfence-portal` and choose the policy matching roles, for instance guest: `internet-only`.

===== CLI authentication

In order to enable CLI login on the Aruba controller via the PacketFence server, you need to point management authentication to the RADIUS server you created while configuring the SSIDs in the previous sections above.

aaa authentication mgmt
  default-role read-only
  enable
  server-group PacketFence

==== Aruba Controller 200

In this section, we cover the basic configuration of the Aruba Controller 200 for PacketFence using the command line interface. We suggest you to use the instructions above for the Web GUI instead.

[float]
===== VLAN definition

Here, we create our PacketFence VLANs, and our AccessPoint VLAN (VID 66). It is recommended to isolate the management of the thin APs in a separate VLAN. 

  vlan 2 
  vlan 3 
  vlan 5 
  vlan 10 
  vlan 66 

[float]
===== AAA Authentication Server

  aaa authentication-server radius "PacketFence"
     host 192.168.1.5
     key useStrongerSecret
  aaa server-group "Radius-Group"
   auth-server PacketFence

[float]
===== AAA Profiles

  aaa profile "default-dot1x"
     authentication-dot1x "default"
     dot1x-default-role "authenticated"
     dot1x-server-group "Radius-Group"
     radius-accounting "Radius-Group"
  aaa profile "PacketFence"
     authentication-mac "pf_mac_auth"
     mac-server-group "Radius-Group"
     radius-accounting "Radius-Group"

[float]
===== WLAN SSIDs: profiles and virtual AP

  wlan ssid-profile "PacketFence-Public"
     essid "PacketFence-Public"
  wlan ssid-profile "PacketFence-Secure"
     essid "PacketFence-Secure"
     opmode wpa2-aes
  wlan virtual-ap "Inverse-Guest"
     aaa-profile "PacketFence"
     ssid-profile "PacketFence-Public"
  wlan virtual-ap "Inverse-Secure"
     aaa-profile "default-dot1x"
     ssid-profile "PacketFence-Secure"
  ap-group "Inverse"
     virtual-ap "Inverse-Guest"
     virtual-ap "Inverse-Secure"
     ids-profile "ids-disabled"

==== All Aruba Instant OS

Add your packetfence instance to your configuration:

wlan auth-server packetfence

  ip 192.168.1.5
  port 1812
  acctport 1813
  timeout 10
  retry-count 5
  key useStrongerSecret
  nas-ip [Aruba Virtual Controller IP]
  rfc3576


Add dynamic vlan rules and mac auth to your ssid profile:

wlan ssid-profile SSID

  index 0 
  type employee
  essid ESSID
  wpa-passphrase WPA-Passphrase
  opmode wpa2-psk-aes
  max-authentication-failures 0
  vlan 1
  auth-server packetfence
  set-vlan Tunnel-Private-Group-Id contains 1 1
  set-vlan Tunnel-Private-Group-Id contains 4 4
  rf-band all
  captive-portal disable
  mac-authentication
  dtim-period 1
  inactivity-timeout 1000
  broadcast-filter none
  radius-reauth-interval 5
  dmo-channel-utilization-threshold 90

=== Belair Networks (now Ericsson)

==== BE20

The Belair Networks BE20s are fairly easy to configure.

===== Add VLANs

On the BE20 Web Interface, click on *Eth-1-1*.  By default, there will be nothing in there.  You need to first create an untagged VLAN (VLAN 0). In order to do that, you need to set
the PVID, Reverse PVID, and the VLAN field to 0.  Then click add.

Repeat that step for each of your VLANs by entering the proper VLAN ID in the VLAN field.
   
===== AAA Servers

Once you have the VLANs setup, you need to add PacketFence into the AAA Server list.  Go to _System -> Radius Servers_.  Click on *Add server*, and fill out the proper information.

* Ensure the Enabled checkbox is selected
* IP Address: Insert the IP Address of the PacketFence Management Interface
* Shared Secret: Insert the shared secret for RADIUS communication

When done, click on the *Apply* button.

===== Secure SSID

Since the BE20 doesn't support Open SSID with MAC Authentication, we will only describe how to configure a WPA2-Enterprise SSID.  First, we will configure the 5GHz antenna.

Click on _Wifi-1-1 -> Access SSID Config_.  From the *Configuration for SSID* dropdown, select the 1 entry.  Modify the fields like the following:

* SSID: Put your SSID Name you would like
* Type: Broadcast
* Use Privacy Mode: WPA2(AES) with EAP/DOT1x
* RADIUS NAS Identifier: You can put a string to identify your AP
* Radius Accounting Enabled: Checkbox Selected
* Radius Station ID Delimiter: dash
* Radius StationId Append Ssid: Checkbox Selected
* RADIUS Server 1: Select the AAA Server you created earlier

When done click *Apply*.  Repeat the same configuration for the 2.4GHz Antenna (Wifi-1-2).

That should conclude the configuration.  You can now save the configs to the flash by hitting the *Config Save* button on top of the Interface.

=== Brocade

==== RF Switches

See the <<_motorola,Motorola RF Switches>> documentation.

=== Cambium

==== cnPilot E410

===== 802.1X

To setup the Cambium cnPilot E410 AP to use 802.1x, first, you need to already have configured the VLANs that will be used in the AP under _Configure -> Network_. Make sure that in _Configure -> Network -> Ethernet Ports_, the port is configured to *Trunk Multiple VLANs*, and the list of VLANs are allowed.

Next, go to _Configure -> WLAN_, and click on `Add New WLAN`. Give it the desired ID, and enter your SSID, default VLAN, and select *WPA2 Enterprise* for Security.

image::cambium-dot1x-basic.png[scaledwidth="100%",alt="Cambium WLAN Basic"]

In the *RADIUS Server_ tab, enter the management IP address of PacketFence (VIP in case of a cluster) and the Radius secret for Authentication and Accounting servers.

Check the *Dynamic Authorization* and *Dynamic VLAN* boxes and save.

image::cambium-dot1x-radius.png[scaledwidth="100%",alt="Cambium WLAN Radius"]

===== MAC Authentication

To enable MAC authentication in the Cambium E410, go to _Configure -> WLAN_, select your WLAN, set the Security to open and click on the tab *Access*.

In the *MAC Authentication* section, select Radius as the policy, and check the box for *Password* to use the MAC address as the password in the Radius request. Click on Save.

image::cambium-mac-auth.png[scaledwidth="100%",alt="Cambium MAC Authentication"]

===== Web Authentication

To enable Web Authentication, go to your WLAN in _Configure -> WLAN_, create a new WLAN with open Security, and click on the tab *Guest Access* to set the following:

* Enable: check the box
* Portal Mode: External Hotspot
* Access Policy: Radius
* Redirect Mode: HTTP
* External Page URL: http://_IP_ADDRESS_OF_PACKETFENCE/Cambium
* External Portal Type: Standard
* Success Action: Your preferred action.
* Prefix Query Strings in Redirect URL: check the box
* Redirection URL Query String: check Client IP
* Redirect: check HTTP-only

Click Save.

In the *Add Whitelist* section, add the IP address or domain name of your PacketFence server, then save.

image::cambium-web-auth.png[scaledwidth="100%",alt="Cambium Web Authentication"]

image::cambium-web-auth-whitelist.png[scaledwidth="100%",alt="Cambium Web Authentication Whitelist"]

On PacketFence web admin, in the Switch configuration for your AP, Roles tab, check Role by Web Auth URL box, and enter http://_IP_ADDRESS_OF_PACKETFENCE/Cambium in the registration field.

image::cambium-role-web-auth.png[scaledwidth="100%",alt="Cambium Role for Web Authentication"]


=== Cisco

==== Aironet 1121, 1130, 1242, 1250, 1600

CAUTION: With this equipment, the same VLAN cannot be shared between two SSIDs. Have this in mind in your design. For example, you need two isolation VLAN if you want to isolate hosts on the public and secure SSIDs.

[float]
===== MAC-Authentication + 802.1X configuration

Radio Interfaces:

----
dot11 vlan-name normal vlan 1
dot11 vlan-name registration vlan 2
dot11 vlan-name isolation vlan 3
dot11 vlan-name guest vlan 5

interface Dot11Radio0
  encryption vlan 1 mode ciphers aes-ccm
  encryption vlan 2 mode ciphers aes-ccm
  ssid PacketFence-Public
  ssid PacketFence-Secure

interface Dot11Radio0.2
  encapsulation dot1Q 2
  no ip route-cache
  bridge-group 253
  bridge-group 253 subscriber-loop-control
  bridge-group 253 block-unknown-source
  no bridge-group 253 source-learning
  no bridge-group 253 unicast-flooding
  bridge-group 253 spanning-disabled

interface Dot11Radio0.3
  encapsulation dot1Q 3
  no ip route-cache
  bridge-group 254
  bridge-group 254 subscriber-loop-control
  bridge-group 254 block-unknown-source
  no bridge-group 254 source-learning
  no bridge-group 254 unicast-flooding
  bridge-group 254 spanning-disabled

interface Dot11Radio0.5
  encapsulation dot1Q 5
  no ip route-cache
  bridge-group 255
  bridge-group 255 subscriber-loop-control
  bridge-group 255 block-unknown-source
  no bridge-group 255 source-learning
  no bridge-group 255 unicast-flooding
  bridge-group 255 spanning-disabled
----

LAN interfaces:

----
interface FastEthernet0.2
  encapsulation dot1Q 2
  no ip route-cache
  bridge-group 253
  no bridge-group 253 source-learning
  bridge-group 253 spanning-disabled

interface FastEthernet0.3
  encapsulation dot1Q 3
  no ip route-cache
  bridge-group 254
  no bridge-group 254 source-learning
  bridge-group 254 spanning-disabled

interface FastEthernet0.5
  encapsulation dot1Q 5
  no ip route-cache
  bridge-group 255
  no bridge-group 255 source-learning
  bridge-group 255 spanning-disabled
----

Then create the two SSIDs:

----
dot11 ssid PacketFence-Secure
  vlan 3 backup normal
  authentication open eap eap_methods
  authentication key-management wpa

dot11 ssid PacketFence-Public
  vlan 2 backup guest
  authentication open mac-address mac_methods
  mbssid guest-mode
----

Configure the RADIUS server (we assume here that the FreeRADIUS server and the PacketFence server are located on the same box):

----
radius-server host 192.168.1.5 auth-port 1812 acct-port 1813 key useStrongerSecret
aaa group server radius rad_eap
  server 192.168.1.5 auth-port 1812 acct-port 1813
aaa authentication login eap_methods group rad_eap
aaa group server radius rad_mac
  server 192.168.1.5 auth-port 1812 acct-port 1813
aaa authentication login mac_methods group rad_mac
----

==== Aironet 1600

CoA and radius:

----
radius-server attribute 32 include-in-access-req format %h
radius-server vsa send accounting
aaa server radius dynamic-author
 client 192.168.1.5
 server-key 7 useStrongerSecret
 port 3799
 auth-type all
----

==== Aironet (WDS)

  To be contributed...


==== Wireless LAN Controller (WLC) or Wireless Services Module (WiSM)

In this section, we cover the basic configuration of the WiSM for PacketFence using the web interface.

* First, globally define the FreeRADIUS server running on PacketFence
  (PacketFence's IP) and make sure _Support for RFC 3576_ (also called _Support for CoA_) is enabled. When the option is missing from your WLC, it is enabled by default.

image::cisco-wlc-radius-define.png[scaledwidth="100%",alt="Freeradius server"]

* Then we create two SSIDs:
[options="compact"]
** PacketFence-Public: non-secure with MAC authentication only
** PacketFence-Secure: secure with WPA2 Enterprise PEAP/MSCHAPv2

image::cisco-wlc-ssid-create.png[scaledwidth="100%",alt="SSID creation"]

* In the secure SSID, make sure 802.1X is enabled and select the appropriate encryption for your needs (recommended: WPA + WPA2)

image::cisco-wlc-l2-secu.png[scaledwidth="100%",alt="SSID L2 secure"]

* No layer 3 security

image::cisco-wlc-l3-secu.png[scaledwidth="100%",alt="SSID L3 secure"]

* We set the IP of the FreeRADIUS server

image::cisco-wlc-secure-radius.png[scaledwidth="100%",alt="Radius secure"]

* VERY IMPORTANT: Allow AAA override (this allows VLAN assignment from RADIUS)

image::cisco-wlc-secure-radius-advance.png[scaledwidth="100%",alt="Radius advanced secure"]

* Edit the non-secure SSID: Enable MAC authentication at level 2

image::cisco-wlc-l2-non-secure.png[scaledwidth="100%",alt="SSID L2 non secure"]

* Nothing at level 3

image::cisco-wlc-l3-non-secure.png[scaledwidth="100%",alt="SSID L3 non secure"]

* We set the IP of the FreeRADIUS server

image::cisco-wlc-secure-radius.png[scaledwidth="100%",alt="Radius secure"]

* VERY IMPORTANT: Allow AAA override (this allows VLAN assignment from RADIUS)

image::cisco-wlc-non-secure-radius-advance.png[scaledwidth="100%",alt="Radius advanced non secure"]

* Finally, in _Controller -> Interfaces_ tab, create an interface per VLAN that could be assigned

image::cisco-wlc-interface-ssid.png[scaledwidth="100%",alt="SSID Interface"]

WARNING: When creating interfaces, it's important to configure DHCP servers. Otherwise, WLC will block DHCP requests.

You are good to go!

===== Wireless LAN Controller (WLC) Web Auth

In this section, we cover the basic configuration of the WLC Web Auth for PacketFence using the web interface.
The idea is to forward the device to the captive portal with an ACL if the device is in an unreg state and 
allow the device to reach Internet (or the normal network) by changing the ACL once registered.
In the unreg state, the WLC will intercept the HTTP traffic and forward the device to the captive portal.

In this sample configuration, the captive portal uses the IP address 172.16.0.250, the administration interface
uses the IP address 172.16.0.249 and the WLC uses the IP address 172.16.0.248.
The DHCP and DNS servers are not managed by PacketFence (WLC DHCP Server, Production DHCP Server)

* First, globally define the FreeRADIUS server running on PacketFence
  (PacketFence's Administration Interface) and make sure _Support for RFC 3576_ is enabled (if not present it is enabled by default)

* Then we create a SSID:
[options="compact"]
** OPEN SSID: non-secure with MAC authentication only

image::SSID_1.png[scaledwidth="100%",alt="SSID step 1"]

image::SSID_2.png[scaledwidth="100%",alt="SSID step 2"]

image::SSID_3.png[scaledwidth="100%",alt="SSID step 3"]

image::SSID_4.png[scaledwidth="100%",alt="SSID step 4"]

image::SSID_5.png[scaledwidth="100%",alt="SSID step 5"]

image::SSID_6.png[scaledwidth="100%",alt="SSID step 6"]

NOTE: On more recent controllers, the value 'Radius NAC' in the 'NAC State' setting will be called 'ISE NAC'.

image::SSID_7.png[scaledwidth="100%",alt="SSID step 7"]

* Then you have to create two ACLs - one to deny all traffic except the required one to hit the portal (Pre-Auth-For-WebRedirect ) and the other
one to allow anything (Authorize_any) .

image::ACL.png[scaledwidth="100%",alt="ACL"]

* Then the last step is to configure the WLC in PacketFence.
Role by Web Auth URL

image::wlc_packetfence.png[scaledwidth="100%",alt="ACL"]

Role definition

image::wlc_packetfence2.png[scaledwidth="100%",alt="ACL"]

===== Wireless LAN Controller (WLC) IPSK

In this section, we cover the basic configuration of the WLC IPSK feature.
Starting from WLC 8.5 release, Cisco introduces the IPSK feature.
Identity PSKs are unique pre-shared keys created for individuals or groups of users on the same SSID.

In this section we will cover the WLC configuration and the PacketFence configuration.

WLC Configuration:


* First, globally define the RADIUS server running on PacketFence
  (PacketFence's IP) and make sure _Support for RFC 3576_ (also called _Support for CoA_) is enabled. When the option is missing from your WLC, it is enabled by default.

* Next, configure a new SSID like in the following screenshots

image::ipsk1.png[scaledwidth="100%",alt="SSID step 1"]

image::ipsk2.png[scaledwidth="100%",alt="SSID step 2"]

image::ipsk_radius.png[scaledwidth="100%",alt="SSID step 3"]

image::ipsk_advanced.png[scaledwidth="100%",alt="SSID step 4"]

PacketFence Configuration:

* First because there is no way to detect in the RADIUS request that the request is for an SSID configured for IPSK, you need to configure PacketFence to trigger IPSK on a connection profile.
  To do that, create a new connection profile, set a Filter based on the SSID (Example SSID PSK_SSID), enable IPSK and set a default PSK key.
  So each time a device will connect on this specific SSID PacketFence will know that it has to answer with specific VSA attributes.

* Second step is to associate the device to a user, you have two ways to do it, the first one is to manually edit an user and in Miscellaneous tab fill the PSK entry (8 characters minimum) then edit
  a node and change the owner with the one you just edit before.
  The second way to associate the device is to use a provisioner. There are also 2 ways to do it, use the "IPSK" provisioner (it will show you a page on the portal with the PSK key to use and the 
  SSID to connect to, or use the "Windows/Apple Devices/Android" provisioner and configure it to do IPSK.

image::dpsk_provisioner.png[scaledwidth="100%",alt="Provisioner IPKS"]


==== Troubleshooting ignored RADIUS replies

In the event the WLC ignores the RADIUS replies from PacketFence (you receive multiple requests but access is never granted), validate the following elements : 

* RADIUS secret is properly configured in PacketFence and the WLC controller.
* The SSL certificate used by PacketFence is not expired.

==== Device Sensor

When using a Cisco WLC, you can enable device sensor by making sure the configuration looks like the following screenshot:

image::wlc-device-sensor.png[scaledwidth="100%",alt="Device Sensor"]

NOTE: Please refer to the wired configuration of Cisco equipment to learn more about device sensor.

=== CoovaChilli

include::networkdevice/coovachilli.asciidoc[]


=== D-Link

==== DWL Access-Points and DWS 3026

NOTE: To be contributed...


=== Extricom

==== EXSW Wireless Switches (Controllers)

In order to have the Extricom controller working with PacketFence, you need to define two ESSID definition, one for the "public" network, and one for the "secure" network. This can be done under a very short time period since Extricom supports RADIUS assigned VLANs out of the box.

You first need to configure you RADIUS server. This is done under the: _WLAN Settings -> RADIUS_ tab. Enter the PacketFence RADIUS server information. For the ESSID configuration. in the administration UI, go to _WLAN Settings -> ESSID definitions_. Create the profiles per the following:

[float]
===== Public SSID

* MAC Authentication must be ticked
* Encryption method needs to be set to None
* Select PacketFence as the MAC Authentication RADIUS server (previously added)

[float]
===== Secure SSID

* Encryption method needs to be set to WPA Enterprise/WPA2 Enterprise
* AES only needs to be selected
* Select PacketFence as the RADIUS server (previously added)

The final step is to enable SNMP Agent and SNMP Traps on the controller. This is done under the following tab in the administrative UI: _Advanced -> SNMP_.

=== Fortinet FortiGate

This section shows how to configure a 802.1X SSID on a Fortigate 50E running on FortiOS 5.4.

You will need to have the CLI access on the Fortigate to do the configuration.

==== RADIUS

 FGT50E # config user radius 
 FGT50E (radius) # edit packetfence
 new entry 'packetfence' added
 FGT50E (packetfence) # set server 192.168.1.5
 FGT50E (packetfence) # set secret useStrongerSecret
 FGT50E (packetfence) # set nas-ip 192.168.1.1
 FGT50E (packetfence) # set radius-coa enable 
 FGT50E (packetfence) # config accounting-server 
 FGT50E (accounting-server) # edit 1
 new entry '1' added
 FGT50E (1) # set status enable
 FGT50E (1) # set server 192.168.1.5
 FGT50E (1) # set secret useStrongerSecret
 FGT50E (1) # end
 FGT50E (packetfence) # end

==== 802.1X SSID

 FGT50E #config wireless-controller vap
 FGT50E (vap) # edit PF-Secure
 new entry 'PF-Secure' added
 FGT50E (PF-Secure) # edit "PF-Secure"
 FGT50E (PF-Secure) # set vdom "root"
 FGT50E (PF-Secure) # set ssid "PF-Secure"
 FGT50E (PF-Secure) # set security wpa2-only-enterprise
 FGT50E (PF-Secure) # set auth radius
 FGT50E (PF-Secure) # set radius-server "packetfence"
 FGT50E (PF-Secure) # set schedule "always"
 FGT50E (PF-Secure) # set local-bridging enable
 FGT50E (PF-Secure) # set dynamic-vlan enable
 FGT50E (PF-Secure) # end

=== Hostapd

include::networkdevice/hostapd.asciidoc[]

=== Huawei

==== AC6605 Controller

PacketFence supports this controller with the following technologies:

* Wireless 802.1X
* Wireless MAC Authentication

===== Controller configuration

Setup NTP server:

	<AC>system-view
	[AC] ntp-service unicast-server 208.69.56.110

Setup the radius server (@IP of PacketFence) authentication + accounting:

[NOTE]
===============================
In this configuration I will use the ip address of the VIP of PacketFence: 192.168.1.2; Registration VLAN : 145, Isolation VLAN : 146
===============================

	<AC>system-view
	[AC] radius-server template radius_packetfence
	[AC-radius-radius_packetfence] radius-server authentication 192.168.1.2 1812 weight 80
	[AC-radius-radius_packetfence] radius-server accounting 192.168.1.2 1813 weight 80
	[AC-radius-radius_packetfence] radius-server shared-key cipher s3cr3t
	[AC-radius-radius_packetfence] undo radius-server user-name domain-included
	[AC-radius-radius_packetfence] quit
	[AC] radius-server authorization 192.168.1.2 shared-key cipher s3cr3t server-group radius_packetfence
	[AC] aaa
	[AC-aaa] authentication-scheme radius_packetfence
	[AC-aaa-authen-radius_packetfence] authentication-mode radius
	[AC-aaa-authen-radius_packetfence] quit
	[AC-aaa] accounting-scheme radius_packetfence
	[AC-aaa-accounting-radius_packetfence] accounting-mode radius
	[AC-aaa-accounting-radius_packetfence] quit
	
	[AC-aaa] domain your.domain.com
	[AC-aaa-domain-your.domain.com] authentication-scheme radius_packetfence
	[AC-aaa-domain-your.domain.com] accounting-scheme radius_packetfence
	[AC-aaa-domain-your.domain.com] radius-server radius_packetfence
	[AC-aaa-domain-your.domain.com] quit
	[AC-aaa] quit

===== Create an Secure dot1x SSID

Activate the dotx globally:

	<AC>system-view
	[AC] dot1x enable

Create your secure dot1x ssid:

Configure WLAN-ESS 0 interfaces:
	
	[AC] interface Wlan-Ess 0
	[AC-Wlan-Ess0] port hybrid untagged vlan 145 to 146
	[AC-Wlan-Ess0] dot1x enable
	[AC-Wlan-Ess0] dot1x authentication-method eap
	[AC-Wlan-Ess0] permit-domain name your.domain.com
	[AC-Wlan-Ess0] force-domain name your.domain.com
	[AC-Wlan-Ess0] default-domain your.domain.com
	[AC-Wlan-Ess0] quit

===== Configure AP parameters:
	
Configure radios for APs:

	[AC] wlan
	[AC-wlan-view] wmm-profile name huawei-ap
	[AC-wlan-wmm-prof-huawei-ap] quit
	[AC-wlan-view] radio-profile name huawei-ap
	[AC-wlan-radio-prof-huawei-ap] radio-type 80211gn
	[AC-wlan-radio-prof-huawei-ap] wmm-profile name huawei-ap
	[AC-wlan-radio-prof-huawei-ap] quit
	[AC-wlan-view] ap 1 radio 0
	[AC-wlan-radio-1/0] radio-profile name huawei-ap
	Warning: Modify the Radio type may cause some parameters of Radio resume defaul
	t value, are you sure to continue?[Y/N]: y
	[AC-wlan-radio-1/0] quit
	
Configure a security profile named huawei-ap. Set the security policy to WPA authentication, authentication method to 802.1X+PEAP, and encryption mode to CCMP:

	[AC-wlan-view] security-profile name huawei-ap-wpa2
	[AC-wlan-sec-prof-huawei-ap-wpa2] security-policy wpa2
	[AC-wlan-sec-prof-huawei-ap-wpa2] wpa-wpa2 authentication-method dot1x encryption-method ccmp
	[AC-wlan-sec-prof-huawei-ap-wpa2] quit

Configure a traffic profile:

	[AC-wlan-view] traffic-profile name huawei-ap
	[AC-wlan-wmm-traffic-huawei-ap] quit

Configure service sets for APs, and set the data forwarding mode to direct forwarding:

The direct forwarding mode is used by default.
	
	[AC-wlan-view] service-set name PacketFence-dot1x
	[AC-wlan-service-set-PacketFence-dot1x] ssid PacketFence-Secure
	[AC-wlan-service-set-PacketFence-dot1x] wlan-ess 0
	[AC-wlan-service-set-PacketFence-dot1x] service-vlan 1
	[AC-wlan-service-set-PacketFence-dot1x] security-profile name huawei-ap-wpa2
	[AC-wlan-service-set-PacketFence-dot1x] traffic-profile name huawei-ap
	[AC-wlan-service-set-PacketFence-dot1x] forward-mode tunnel
	[AC-wlan-service-set-PacketFence-dot1x] quit

Configure VAPs and deliver configurations to the APs:

	[AC-wlan-view] ap 1 radio 0
	[AC-wlan-radio-1/0] service-set name PacketFence-dot1x
	[AC-wlan-radio-1/0] quit
	[AC-wlan-view] commit ap 1

===== Create your Open ssid

Activate the mac-auth globally:

	<AC>system-view
	[AC] mac-authen
	[AC] mac-authen username macaddress format with-hyphen
	[AC] mac-authen domain your.domain.com

Create your Open ssid:

Configure WLAN-ESS 1 interfaces:

	[AC] interface Wlan-Ess 1
	[AC-Wlan-Ess1] port hybrid untagged vlan 145 to 146
	[AC-Wlan-Ess1] mac-authen
	[AC-Wlan-Ess1] mac-authen username macaddress format without-hyphen
	[AC-Wlan-Ess1] permit-domain name your.domain.com
	[AC-Wlan-Ess1] force-domain name your.domain.com
	[AC-Wlan-Ess1] default-domain your.domain.com
	[AC-Wlan-Ess1] quit

Configure AP parameters:

Configure a security profile named huawei-ap-wep. Set the security policy to WEP authentication.
	
	[AC]wlan
	[AC-wlan-view] security-profile name huawei-ap-wep
	[AC-wlan-sec-prof-huawei-ap-wep] security-policy wep
	[AC-wlan-sec-prof-huawei-ap-wep] quit

Configure service sets for APs, and set the data forwarding mode to direct forwarding:

The direct forwarding mode is used by default.
	
	[AC-wlan-view] service-set name PacketFence-WEP
	[AC-wlan-service-set-PacketFence-WEP] ssid PacketFence-Open
	[AC-wlan-service-set-PacketFence-WEP] wlan-ess 1
	[AC-wlan-service-set-PacketFence-WEP] service-vlan 1
	[AC-wlan-service-set-PacketFence-WEP] security-profile name huawei-ap-wep
	[AC-wlan-service-set-PacketFence-WEP] traffic-profile name huawei-ap (already created before)
	[AC-wlan-service-set-PacketFence-WEP] forward-mode tunnel
	[AC-wlan-service-set-PacketFence-WEP] quit

Configure VAPs and deliver configurations to the APs:

	[AC-wlan-view] ap 1 radio 0
	[AC-wlan-radio-1/0] service-set name PacketFence-WEP
	[AC-wlan-radio-1/0] quit
	[AC-wlan-view] commit ap 1



=== Meraki

To add the AP on PacketFence use the internal IP of the AP.

The 'Disconnect port' field must be set to '1700'.

==== WebAuth

In this section, we will cover the configuration of the Meraki controller to use Web authentication.

NOTE: While using the WebAuth mode on the Meraki controller, you need to use "Role mapping by Switch Role" and "Role by Web Auth URL" in the tab 'Roles' from the switch configuration.

Configure your SSID as shown below:

image::Meraki-V2-1.png[scaledwidth="100%",alt="Security and RADIUS configuration"]

image::Meraki-V2-2.png[scaledwidth="100%",alt="Network configuration"]

NOTE: It is mandatory that you use the Airespace-ACL-Name as "RADIUS attribute specifying group policy name".

The switch module to use for this configuration is "Meraki cloud controller V2".

Next, configure the roles for the devices on your network. Go in 'Network-wide->Group policies', then you will be able to create policies that can be configured as roles in the switch configuration of PacketFence. Creation of the policy `Guest`:

image::Meraki-config-policy.png[scaledwidth="100%",alt="Group policies"]

Your configuration for the tab "Roles" in PacketFence will look like the following:

image::meraki-config-pf-role.png[scaledwidth="100%",alt="PacketFence role configuration"]

image::meraki-config-pf-url.png[scaledwidth="100%",alt="PacketFence URL configuration"]

URL in registration field should be in the form: 'http://<your_captive_portal_ip>/Meraki::MR_v2'

==== VLAN enforcement

This section will cover how to configure the Meraki WiFI controller to use with VLAN enforcement, use the configuration in the section `WebAuth` for the SSID.

In the configuration of PacketFence, use "Role by VLAN ID" and fill your VLANs matching roles.

image::meraki-vlan-pf.png[scaledwidth="100%",alt="PacketFence role configuration"]

===== Switch MS220-8

NOTE: You should already have one port setup as Uplink, using a mode trunk, with at least your Registration and Production VLAN allowed on it.

The Meraki switch offer configuration for VLAN enforcement only.

You will need to access the Meraki dashboard to configure your switch. When you reach it you will need first to create a policy. You can create a "MAC authentication bypass" or a "802.1X" policy. Depending if you want to authenticate user via dot1x or MAB. You cannot combine both neither use a fallback mode on the same port, each port with a policy applied will be exclusive to MAB or dot1x.

To access the policy creation go to 'Switch->Access policies' in the Meraki dashboard menu. From there create a new policy, use the example below to create your policy.

image::Meraki-switch-policies.png[scaledwidth="100%",alt="Access policies"]

You now need to apply one of your policies to ports. To do so, go to 'Switch->Switch ports' and chose your options. To add a policy you created earlier, select it in the drop down list in `Access policy`. You need to configure the port in "mode access", the default access VLAN is not important if your VLANs are properly configured on PacketFence.

image::Meraki-switch-port.png[scaledwidth="100%",alt="Switch Ports"]

===== RADSEC

It is possible to use RADSEC between Meraki and PacketFence in order to perform RADIUS over TCP and encrypted using TLS. Before performing the steps outlined in this section, make sure you have a working SSID using normal unencrypted RADIUS by following the steps in the sections above

Then, in order to enable RADSEC, go in your SSID configuration and under 'RADIUS proxy', select 'Use Meraki proxy' and save the settings.

After saving, check the RADSEC checkbox and save your settings.

Now, on your PacketFence server, you must add the Meraki CA root to the trusted Certificate Authorities of FreeRADIUS when performing RADSEC. You should download the Meraki CA certificate from here http://changeme.com/meraki-root.crt and append it to the content of /usr/local/pf/raddb/certs/ca.pem on your PacketFence server.

Next, restart radiusd to reload the CA certificates using:

  # /usr/local/pf/bin/pfcmd service radiusd restart

NOTE: RADSEC is done over port 2083 so make sure your server is available via a public IP address for this port and allows connections from your Meraki cloud controller. Refer to the Meraki documentation for details.

=== Mikrotik

This configuration has been tested on Access Point OmniTIK U-5hnD with RouterOS v6.18 and only MAC-Authentication is available now.
The only deauthentication method available is SSH, so create an account in the Mikrotik AP and fill the information in PacketFence switch configuration.
Also don't forget to use the pf account to ssh on the Access Point to receive the ssh key.

[float]
==== Open SSID

In this setup we use the interface ether5 for the bridge (Trunk interface) and ether1 as the management interface.

Configure your access point with the following configuration:

  /interface wireless
  # managed by CAPsMAN
  # channel: 5180/20-Ce/an(17dBm), SSID: OPEN, local forwarding
  set [ find default-name=wlan1 ] band=5ghz-a/n channel-width=20/40mhz-Ce disabled=no l2mtu=1600 mode=ap-bridge ssid=MikroTik-05A64D
  /interface ethernet
  set [ find default-name=ether1 ] name=ether1-gateway
  set [ find default-name=ether2 ] name=ether2-master-local
  set [ find default-name=ether3 ] master-port=ether2-master-local name=ether3-slave-local
  set [ find default-name=ether4 ] master-port=ether2-master-local name=ether4-slave-local
  set [ find default-name=ether5 ] name=ether5-master-local
  /interface vlan
  add interface=BR-CAPS l2mtu=1594 name=default vlan-id=1
  add interface=BR-CAPS l2mtu=1594 name=isolation vlan-id=3
  add interface=BR-CAPS l2mtu=1594 name=registration vlan-id=2
  /caps-man datapath
  add bridge=BR-CAPS client-to-client-forwarding=yes local-forwarding=yes name=datapath1
  /caps-man interface
  # 
  add arp=enabled configuration.mode=ap configuration.ssid=OPEN datapath=datapath1 disabled=no l2mtu=1600 mac-address=\
      D4:CA:6D:05:A6:4D master-interface=none mtu=1500 name=cap1 radio-mac=D4:CA:6D:05:A6:4D
  /caps-man aaa
  set interim-update=5m
  /caps-man access-list
  add action=query-radius interface=cap1 radius-accounting=yes signal-range=-120..120 time=0s-1d,sun,mon,tue,wed,thu,fri,sat
  /caps-man manager
  set enabled=yes
  /interface bridge port
  add bridge=bridge-local interface=ether2-master-local
  add bridge=bridge-local interface=ether1-gateway
  add bridge=BR-CAPS interface=ether5-master-local
  /interface wireless cap
  set bridge=BR-CAPS discovery-interfaces=BR-CAPS enabled=yes interfaces=wlan1
  /ip accounting
  set enabled=yes
  /radius
  add address=192.168.1.5 secret=useStrongerSecret service=wireless
  /radius incoming
  set accept=yes

==== Webauth

You can use webauth (external captive portal) on Mikrotik APs. In order to do so, you will have to activate the hotspot feature in the AP configuration as well as modify the redirection template so that it points to PacketFence.

First, you must establish an FTP connection to your access point and replace the content of `hotspot/login.html` with the following:

  <html>
  <head><title>...</title></head>
  <body>
  $(if chap-id)
  <noscript>
  <center><b>JavaScript required. Enable JavaScript to continue.</b></center>
  </noscript>
  $(endif)
  <center>If you are not redirected in a few seconds, click 'continue' below<br>
  <form name="redirect" action="http://192.168.1.5/Mikrotik" method="get">
    <input type="hidden" name="mac" value="$(mac)">
    <input type="hidden" name="ip" value="$(ip)">
    <input type="hidden" name="username" value="$(username)">
    <input type="hidden" name="link-login" value="$(link-login)">
    <input type="hidden" name="link-orig" value="$(link-orig)">
    <input type="hidden" name="error" value="$(error)">
    <input type="hidden" name="chap-id" value="$(chap-id)">
    <input type="hidden" name="chap-challenge" value="$(chap-challenge)">
    <input type="hidden" name="link-login-only" value="$(link-login-only)">
    <input type="hidden" name="link-orig-esc" value="$(link-orig-esc)">
    <input type="hidden" name="mac-esc" value="$(mac-esc)">
    <input type="hidden" name="ap-id" value="AP_IP_ADDRESS_HERE">
    <input type="submit" value="continue">
  </form>
  <script language="JavaScript">
  <!--
     document.redirect.submit();
  //-->
  </script></center>
  </body>
  </html>

Next, in the `login.html` you have just uploaded, make sure you change `AP_IP_ADDRESS_HERE` by the management IP address of your access point and `192.168.1.5` by the IP address of your PacketFence captive portal.

Now, you must configure the hotspot feature on your AP. This configuration is done on top of an existing SSID you have previously configured which is on interface `wlan1`. Adjust the interface name if needed.

  /ip hotspot
  setup

  hotspot interface: wlan1

  local address of network: 10.5.50.1/24
  masquerade network: yes
  
Set pool for HotSpot addresses 

  address pool of network: 10.5.50.2-10.5.50.254

Select hotspot SSL certificate 

  select certificate: none

Select SMTP server 

  ip address of smtp server: 0.0.0.0
  
Setup DNS configuration 

  dns servers: 8.8.8.8
  
DNS name of local hotspot server 

  dns name: myhotspot
  
Create local hotspot user 

  name of local hotspot user: admin
  password for the user: 


Next, you need to allow access to the PacketFence portal in the hotspot access list. Change `192.168.1.5` with the IP address you pointed to in `login.html`

  /ip hotspot walled-garden
  add dst-host=192.168.1.5
  add src-address=192.168.1.5

  /ip hotspot walled-garden ip
  add action=accept disabled=no dst-host=192.168.1.5
  add action=accept disabled=no src-address=192.168.1.5

Now, you will also need to configure the hotspot to point to your PacketFence RADIUS server:

  /radius
  add address=192.168.1.5 secret=useStrongerSecret service=hotspot

  /ip hotspot profile
  add hotspot-address=10.5.50.1 name=hsprof1 use-radius=yes

Next, you need to configure PacketFence to use webauth for this Access Point using the following `switches.conf` configuration. Change `AP_IP_ADDRESS_HERE` by the IP address you've put in login.html.

  [AP_IP_ADDRESS_HERE]
  VlanMap=Y
  RoleMap=N
  mode=production
  ExternalPortalEnforcement=Y
  type=Mikrotik
  radiusSecret=useStrongerSecret
  registrationVlan=-1

=== HP

==== ProCurve Controller MSM710

  To be contributed...

=== Meru

==== Meru Controllers (MC)

In this section, we cover the basic configuration of the Meru wireless controller for PacketFence via the web GUI.

[float]
===== Disable PMK Caching

If you are running a WPA2 SSID, you may need to disable PMK caching in order to avoid deauthentication issues.  This is true if you are running AP 300s using any 5.0 versions including 5.0-87, or any versions below 4.0-160.

Here are the commands to run to disable the PMK caching at the AP level.  First, login the AP, and run this command to see which radios are broadcasting your SSID.
   vap display

Second, disable the PMK caching on those radios.
   radio pmkid radio00 disable

You can also add those commands to the AP bootscript.  Contact your Meru support representative for that part.

[float]
===== VLAN Definition

Here, we create our PacketFence VLANs for client use. Go to _Configuration -> Wired -> VLAN_, and select Add.

* VLAN Name is the human readable name (ie. RegistrationVLAN)
* Tag is the VLAN ID
* Fast Ethernet Interface Index refers to the controller's ethernet interface
* IP Address – An IP address for this controller on this VLAN
* Netmask – Network mask for this VLAN
* IP Address of the default gateway – Wired IP router for this VLAN
* Set the Override Default DHCP server flag to off
* Leave the DHCP server IP address and the DHCP relay Pass-Through to default

Click *OK* to add the VLAN.

[float]
===== AAA Authentication Server 

Here, we create our PacketFence RADIUS server for use. Under _Configuration -> Security -> Radius_, select *Add*.

* Give the RADIUS Profile a name
* Write a description of the profile
* Give the RADIUS IP, RADIUS Secret and the RADIUS authentication port
* Select Colon for the MAC address delimiter
* Select MAC Address as the password type

Click *OK* to add the RADIUS profile.

[float]
===== AAA Accounting Server 

Here, we create our PacketFence RADIUS server for use. Under _Configuration -> Security -> Radius_, select *Add*.

* Give the RADIUS Profile a name
* Write a description of the profile
* Give the RADIUS IP, RADIUS Secret and the RADIUS accounting port
* Select Colon for the MAC address delimiter
* Select MAC Address as the password type

Click *OK* to add the RADIUS accounting profile.

[float]
===== AAA Profiles – Open SSID

Here, we create our wireless security profiles for use. 
Under _Configuration -> Security -> Profile_, select *Add*.

* Give the security profile a name
* Select Clear as the L2 Modes Allowed
* Leave Data Encrypt empty
* Disable the Captive Portal
* Enable the Mac Filtering

Click *OK* to save the profile.

[float]
===== MAC Filtering

When using the OpenSSID, you need to activate the mac filtering. 
Under _Configuration -> Mac Filtering_:

* Set ACL Environment State to Permit list enabled
* Select your RADIUS profile

[float]
===== AAA Profiles – Secure SSID

Here, we create our wireless security profiles for use. 
Under _Configuration -> Security -> Profile_, select *Add*.

* Give the security profile a name
* Select WPA2 as the L2 Modes Allowed
* Select CCMP-AES for Data Encrypt
* Select your PacketFence RADIUS Authentication Profile
* Disable the Captive Portal
* Enable the 802.1X network initiation
* Leave the Mac Filtering to off

Click *OK* to save the profile.

[float]
===== WLAN SSIDs

Here, we create our SSID and tie it to a security profile. 
Under _Configuration -> Wireless -> ESS_, select *Add*.

* Give the ESS profile a name, and enable it
* Write an SSID name
* Select your security profile name previously created
* Select your PacketFence RADIUS Accounting Profile (if you want to do accounting)
* Enable the SSID Broadcast
* Make the new AP to join the ESS
* Set the tunnel interface type to RADIUS and Configured VLAN
* Select the registration VLAN for the VLAN Name

Click *OK* to create the SSID. Repeat those steps for the open and secure SSID by choosing the right security profile.

[float]
===== WLAN SSIDs – Adding to access point

Here, we tie our SSIDs to access points. 
Under _Configuration -> Wireless -> ESS_, select the SSID you want to add to your aps. Then, select the *ESS-AP Table*, and click *Add*.

* Select the AP ID from the drop down list
* Click *OK* to associate the SSID with this AP

[float]
===== Roles (Per-User Firewall)

Since PacketFence 3.3.0, we now support roles (per-user firewall rules) for the Meru hardware.  To add firewall rules, go in _Configuration -> QoS System Settings -> QoS and Firewall Rules_.  When you add a rule, you have to pay attention to two things:

* The rule is applied to the controller physical interface right away, so make sure you are not too wide on your ACL to lock you out!
* The rules are grouped using the Firewall Filter ID (We will use this ID for the roles)

So, since the matching is done using the Firewall Filter ID configuration field, your roles line in switches.conf would look like :

   roles=Guests=1;Staff=2

NOTE: You need to have the *Per-User Firewall* license in order to benefit this feature.

=== Mojo Networks

PacketFence supports SSIDs configured with 802.1X and Web Authentication

==== Create the RADIUS Profile

First, create a RADIUS Profile for PacketFence.

* Login to the https://dashboard.mojonetworks.com
* Go to *Wireless Manager*
* Then click on _Configuration -> Device Configuration -> RADIUS Profiles -> Add a RADIUS Profile_

   Profile Name: NAME_OF_PROFILE_FOR_PACKETFENCE
   IP Address: IP_OF_PACKETFENCE
   Authentication Port: 1812
   Accounting Port: 1813
   Shared Secret: useStrongerSecret

Click on 'Save'.

==== Configure the SSID:

[float]
===== 802.1X Secure

* Login to the https://dashboard.mojonetworks.com
* Go to *Wireless Manager*
* Then click on _Configuration -> Device Configuration -> SSID Profiles -> Add a new Profile -> WLAN_ 

NOTE: (Leave the default configuration for the other settings)

   Profile Name: PF-Secure-802.1X
   SSID: PF-Secure
   Security: WPA2; 802.1X
   NAS ID: %m-%s
   Dynamic VLANs: Enable VLAN Pool 1,2,4,5 (All VLANs that you will use)
   Called-Station-ID: %m-%s
   COA: Checked

   RADIUS Authentication
    Primary Authentication Server: PacketFence RADIUS profile created above.

   RADIUS Accounting Server Details
    Primary Accounting Server: PacketFence RADIUS profile created above.

Click the 'Save' button to save the PF-Secure SSID configuration.

[float]
===== Web Authentication

To enable the external captive portal, go to the *SSID Profiles* page in *Device Configuration*. Add a new Wi-Fi profile with the following attributes:

   Profile Name: Name of the new profile
   SSID: Name of your SSID
   Security: Open

image::mojo-security.png[scaledwidth="100%",alt="Mojo Security"]   
   
   Network: VLAN ID for clients

image::mojo-network-vlan.png[scaledwidth="100%",alt="Mojo Network"]

   Captive Portal: select and fill in External Splash Page with RADIUS Authentication with “http://IP_OR_HOSTNAME_OF_PACKETFENCE/Mojo” and the RADIUS shared secret. Click on *RADIUS Settings* to select PacketFence as authentication and accounting server.

image::mojo-external-splash.png[scaledwidth="100%",alt="Mojo External Splash Page"]

   On the right, add the IP address or hostname of PacketFence to the Walled Garden Sites.

image::mojo-walled-garden.png[scaledwidth="100%",alt="Mojo Walled Garden"]

Save the newly created profile.

==== Broadcast the SSID on the Access Point:

* Go to _Configuration -> Device Template -> System Template_ 
* Then _Radio Settings -> Define settings for model -> Chose your AP model_
* Finally _Radio 1 - 2x2 b/g/n Configuration -> Add SSID Profile -> Select your SSID profile previously created(802.1X or Web authentication profile) -> Ok_

Click the 'Save' button to broadcast the PF-Secure SSID.

==== Configure the Mojo Networks AP in PacketFence:

[float]
===== 802.1X

Add a Switch with the IP address of the Access Point (AP) with the following configuration:

* Go to _Configuration -> Network -> Switches -> Add switch to group -> Default_

   Definition:
    IP Address/MAC Address/Range (CIDR): Local IP of the AP
    Description: Mojo Networks Access Point
    Type: Mojo Networks AP
    Mode: Production
    Switch Group: None
    Deauthentication Method: RADIUS
    Use CoA: Checked

   Roles:
    Role by VLAN ID: Checked
    registration: 2
    isolation: 3
    guest: 5
    default: 1

   NOTE: Role by VLAN ID remain the only category checked.

   Radius:
    Secret Passphrase: useStrongerSecret

[float]
===== Web Authentication

Add a switch with the IP address fo the Access Point (AP) with the following configuration:

* Go to _Configuration -> Network -> Switches -> Add switch to group -> Default_

   Definition:
    IP Address/MAC Address/Range (CIDR): Local IP of the AP
    Description: Mojo Networks Access Point
    Type: Mojo Networks AP
    Mode: Production
    Switch Group: None
    Deauthentication Method: RADIUS
    Use CoA: Checked

   Roles:
    Uncheck Role by VLAN ID

   Radius:
    Secret Passphrase: useStrongerSecret

Click the 'Save' button to save the AP configuration.

IMPORTANT: Clone the newly created switch and enter *192.0.2.254* or the MAC address of the AP.

=== Motorola

In order to have the Motorola RFS controller working with PacketFence, you
need to define two Wireless LANs definition, one for the "public" network,
and one for the "secure" network.

==== WiNG (Firmware >= 5.0)

[float]
===== AAA Policy (RADIUS server)

First, we need to build the AAA Policy. Under _Configuration -> Wireless -> AAA Policy_, click on the *Add* button at the bottom right. Configure the RADIUS profile like the following:

* Host: Choose IP Address in the drop down, and put the RADIUS server (PF) IP
* Insert a RADIUS secret passphrase
* Select "Through Wireless Controller" Request Mode

CAUTION: Since we are using RADIUS Dynamic Authorization, we need to enable the RADIUS accounting. Under the RADIUS accounting tab, click the Add button at the bottom right, and insert the proper values.

[float]
===== Open SSID

Under _Configuration -> Wireless -> Wireless LANs_, click on the *Add* button at the bottom right. Under Basic Configuration:

* Profile Name : Give a convenient name
* SSID: This is the ESSID name
* Ensure that the WLAN Status is set to enable
* Select Single VLAN as VLAN assignment technique
* Ensure that "Allow RADIUS Override" is selected

.Security configuration:
* Select MAC as authentication type
* Select your AAA Policy previously created
* Ensure that you selected Open as the Encryption

.Accounting configuration:
* Make sure you select "Enable RADIUS Accounting"
* Select the previously configured AAA Policy

.Advanced configuration:
* Make sure you select RADIUS Dynamic Authorization

[float]
===== Secure SSID

Under _Configuration -> Wireless -> Wireless LANs_, click on the *Add* button at the bottom right. Under Basic Configuration:

* Profile Name : Give a convenient name
* SSID: This is the ESSID name
* Ensure that the WLAN Status is set to enable
* Select Single VLAN as VLAN assignment technique
* Ensure that "Allow RADIUS Override" is selected

.Security configuration:
* Select EAP as authentication type
* Select your AAA Policy previously created
* Ensure that you selected WPA/WPA2-TKIP as the Encryption
* Unselect everything under Fast Roaming (Disable caching)

.Accounting configuration:
* Make sure you select "Enable RADIUS Accounting"
* Select the previously configured AAA Policy

.Advanced configuration:
* Make sure you select RADIUS Dynamic Authorization

[float]
===== Profile (WLAN Mapping)

You have multiple options here. Either, you create a general AP profile, and you assign it to your Aps, or you modify the AP device configuration to map the WLAN to the radio interfaces. For the purpose of this document, we will modify the general profile. Under _Profiles -> default-apXXX_ (where XXX is your AP model), in _Interface -> Radios_, edit the existing radios settings. Go to the *WLAN Mapping* tab, select the two SSIDs and click on the *<<* button.

[float]
===== Profile (Management)

Here, we can configure our SNMP community strings. Located in _Configuration -> Management -> Management Policy_. Again, you can modify the default one, or you can create a brand new Policy.

[float]
===== VLANs

You need to ensure that the uplink interface of the controller is configured as a trunk, and that all the necessary VLANs are created on the device. This is configured under _Device -> rfsXXXX-MAC_ (where XXXX is your controller series, and MAC is the latest 3 octets of its mac address). Edit the device configuration, and go to _Interface -> Ethernet Ports_. Ensure that the up1 interface is set as trunk, with all the allowed VLANs. Next, create the VLAN under _Interface -> Virtual Interfaces_.

[float]
===== Roles (Per-User Firewall)

Since PacketFence 3.3.0, we now support roles for the Motorola hardware using WiNGS 5.x.  To add roles, go in _Configuration -> Security -> Wireless Client Roles_.  First create a global policy that
will contain your roles.  Next, create your Roles by clicking on the *Add* button on the bottom right.  It is important to configure the Group Configuration line properly by setting the string
name that we will use in the RADIUS packet.  For example, for a Guests Role, you can put *Group Configuration Exact Guests*, and for a Staff Roles, you can put *Group Configuration Exact Staff*. 
In the roles configuration in switches.conf, you would have something like :

   roles=CategoryGuests=Guests;CategoryStaff=Staff

Finally, don't forget to configure the appropriate firewall rules for your Roles!  Make sure also to commit the configuration upon your changes.

NOTE: You need to have an *Advanced Security* license to enable the Per-User Firewall feature.

===== WIPS

In order to enable the WIPS functionality on the Motorola, you need to follow this procedure.  The steps have been done using the CLI.

First, Create a wips-policy:

   wips-policy Rogue-AP
   history-throttle-duration 86400
   event ap-anomaly airjack
   event ap-anomaly null-probe-response
   event ap-anomaly asleap
   event ap-anomaly ad-hoc-violation
   event ap-anomaly ap-ssid-broadcast-in-beacon
   event ap-anomaly impersonation-attack
   ap-detection

Next, create an event policy:

   event-system-policy PF-WIDS
   event wips wips-event syslog off snmp on forward-to-switch off email off

Next, create or adjust your management policy to configure the SNMP traps.  Here is an example policy, please note the two last lines:

   management-policy default
   no http server
   https server
   ssh
   user admin password 1 e4c93663e3356787d451312eeb8d4704ef09f2331a20133764c3dc3121f13a5b role superuser access all
   user operator password 1 7c9b1fbb2ed7d5bb50dba0b563eac722b0676b45fed726d3e4e563b0c87d236d role monitor access all
   no snmp-server manager v3
   snmp-server community public ro
   snmp-server community private rw
   snmp-server user snmpoperator v3 encrypted des auth md5 0 operator
   snmp-server user snmptrap v3 encrypted des auth md5 0 motorola
   snmp-server user snmpmanager v3 encrypted des auth md5 0 motorola
   snmp-server enable traps
   snmp-server host 10.0.0.100 v2c 162

You then need to tell your controller to use the event policy:

   rfs6000 5C-0E-8B-17-F2-E3
   ...
   use event-system-policy PF-WIDS

Finally, you need to configure a radio interface on your AP to act as a sensor.  Here is an example configuration for a dual-radio AP650:

   ap650 00-23-68-86-EB-BC
   use profile default-ap650
   use rf-domain default
   hostname ap650-86EBBC
   country-code ca
   use wips-policy Rogue-AP
   interface radio1
   rf-mode sensor
   channel smart
   power smart
   data-rates default
   no preamble-short
   radio-share-mode off
   interface radio2
   ...


==== Older Firmwares (< 5.0)

.Option for Public Wireless LAN
* Check the Dynamic Assignment check-box
* Select "MAC Authentication" under Authentication
* Click "Config..." choose the Colon delimiter format
* Un-check all encryption options
* Under RADIUS put in PacketFence's RADIUS Server information

.Option for Secure Wireless LAN
* Check the Dynamic Assignment check-box
* Select "802.1X EAP" under Authentication
* Check WPA/WPA2-TKIP encryption option
* Under RADIUS put in PacketFence's RADIUS Server information

[float]
===== SNMP Global configuration

Add the two Read-Only and Read-Write users under _Management Access -> SNMP Access_.


=== Ruckus

[float]
==== AAA Servers

We need to define the RADIUS and RADIUS accounting (mandatory):

Under _Configuration -> AAA Servers_, click on the *Create New* button.  Enter the proper configuration:

* Enter a server name
* Select either RADIUS or RADIUS accounting as the type
* Use PAP as the Auth Method
* Enter the IP address, and shared secret.
* Hit OK

Repeat the steps for the RADIUS and RADIUS accounting types.  We need 1 definition for each otherwise RADIUS dynamic authorization won't work.

[float]
==== WLAN Definitions

Under _Configuration -> WLAN_, click on the *Create New* button.  Enter the proper configuration:

.Open SSID
* Enter a Name/SSID
* Select *Standard Usage* as the Type
* Select *MAC Address* as the authentication type
* Select *Open* as the encryption method
* Select the proper RADIUS server as the authentication server
* Select the proper RADIUS server as the accounting server

NOTE: The Open SSID does *NOT* support dynamic VLAN assignments (Firmware 9.3.0.0.83)

.Secure SSID
* Enter a Name/SSID
* Select *Standard Usage* as the Type
* Select *WPA2* as the authentication type
* Select *AES* as the encryption method
* Select the proper RADIUS server as the authentication server
* Select the proper RADIUS server as the accounting server
* Check the *Enable Dynamic VLAN* checkbox

[float]
==== WIPS

To enable the WIPS feature of the Ruckus in order to send SNMP traps to PacketFence, the setup is fairly simple.  

First, configure the controller to send the traps to PacketFence.  Under _Configure -> System -> Network Management -> SNMP Trap_:

*Select "Enable SNMP Trap"
*Put the PacketFence Management IP in the Trap Server IP field

NOTE: The traps will arrive with the "public" community string

Next, you need to configure the Alarm Settings.  Under _Configure -> Alarm Settings_, make sure the following are selected:

*Rogue AP Detected
*SSID-Spoofing AP Detected
*MAC-Spoofing AP Detected
*LAN Rogue AP Detected

Finally, enable the WIPS feature on the controller.  Under _Configure -> WIPS -> Intrusion Detection and Prevention_, make sure both box are selected, click Apply. 

==== Web Authentication

In order to use PacketFence as an external captive portal for web authentication, you will need to configure first your RADIUS authentication and accounting server (see steps above).

[float]
===== Hotspot configuration

Configure the Hotspot service profile to redirect devices to your PacketFence portal. Go on the ZoneDirector administration web page to the section _Configure->Hotspot Services->Create New_

image::ruckus_hotspot_service.png[scaledwidth="100%",alt="Hotspot Service"]

 1 - Name of your Hotspot service
 2 - Login Page: Url of PacketFence portal interface (http://192.168.1.5/Ruckus)
 3 - Start Page: redirect to the following URL: http://192.168.1.5
 4 - Authentication Server: Select the PacketFence authentication RADIUS server (default port 1812)
 5 - Accounting Server: Select the PacketFence accounting RADIUS server (default 1813)
 6 - Click on the Walled Garden and authorize the IP of PacketFence management interface

Save your configuration.

[float]
===== WLAN configuration

Go to _Configure -> WLANs -> WLANs -> Create New_

image::ruckus_create_ssid.png[scaledwidth="100%",alt="Hotspot Service"]

 1 - Name of your SSID
 2 - Type: Hotspot Service (WISPr)
 3 - Authentication Method: Open
 4 - Encryption Method: None
 5 - Hotspot Services: Your hotspot service name that you configured
 6 - Access VLAN: The VLAN ID that should be assigned to devices after authentication

Save your configuration.

[float]
===== PacketFence configuration

On the ZoneDirector configuration in PacketFence, you will need to specify -1 as the registration VLAN in order to display the captive portal to the end device. 

You will need to deactivate the force secure redirect on the captive portal under _Configuration -> Captive Portal -> Secure redirect -> Unchecked_

The captive portal needs to listen on the management interface, so you will need to add the portal daemon to the management interface under _Configuration -> Interfaces -> Management Interface_


Example:

 [interface eth0]
 ip=192.168.1.5
 type=management,portal
 mask=255.255.255.0

To apply the configuration, restart PacketFence using the following command: service packetfence restart

==== Ruckus Roles

[float]
===== Roles Configuration

Ruckus allows you to define roles. These roles link all users to the internal WLAN and permit access to all WLAN by default. You can still limit access to certain WLAN.

To create a new user Role:

 1 - Go to _Admin & Services -> System -> Roles_. The Roles page appears, displaying a Default role in the Roles table.
 2 - Click Create New.
 3 - Enter a Name and a short Description for this role.
 4 - Choose the options for this role from the following:
    Group Attributes: Fill in this field only if you are creating a user role based on Group attributes extracted from an Active Directory server. Enter the User Group name here. Active Directory/LDAP users with the same group attributes are automatically mapped to this user role.
    Allow All WLANs: You have two options: (1) Allow Access to all WLANs, or (2) Specify WLAN Access. If you select the second option, you must specify the WLANs by clicking the check box next to each one.

image::Ruckus_Roles.png[scaledwidth="100%",alt="Ruckus Roles"]
image::Ruckus_CreateNewRole.png[scaledwidth="100%",alt="Create new role"]


[float]
===== PacketFence Configuration

On the PacketFence side you need to use role by switch role and add the Group Attribute you created on the Ruckus side.

So when a device will connect on the SSID, PacketFence will return a VLAN identifier and a RuckusUserGroup attribute and if the role is allowed on the WLAN then the device will be authorized on the WLAN.
In the case that the role is not allowed on the WLAN then the device will not be allowed to connect.


=== Ruckus SmartZone

==== Webauth

==== SmartZone configuration

First, you will need to define your RADIUS server in _Configuration -> Service and Profiles -> Authentication_.

Create your server using the following information (where 192.168.1.5 is the IP address of your PacketFence management interface):

* 'IP Address:' 192.168.1.5
* 'Port': 1812
* 'Secret': useStrongerSecret

Then, in _Configuration -> Service and Profiles -> Accounting_, create a server with the following information:

* 'IP Address:' 192.168.1.5
* 'Port': 1813
* 'Secret': useStrongerSecret

After, create a Hotspot in _Configuration -> AP Zones -> Your Zone -> Hotspot WISPr -> Create New_. Adjust 192.168.1.5 to the IP address of your portal.

image::ruckus-smartzone-webauth-hotspot.png[scaledwidth="100%",alt="Ruckus SmartZone Hotspot"]

Then, still on this page, in the 'Walled Gardens', make sure you add the portal IP address in this list.

Next, you will need to configure your WLAN to use the Hotspot authentication and point it to PacketFence. Also ensure you set 'Use the controller as a proxy'.

image::ruckus-smartzone-webauth-ssid.png[scaledwidth="100%",alt="Ruckus SmartZone SSID"]

Now, you should configure the Northbound API of the SmartZone so PacketFence can communicate with it. In order to do so, go in _Configuration -> System -> Northbound Portal Interface_ and set the 'Password' and save it. Keep the password closeby as it will be required for the PacketFence configuration. In this example, it will be `passwordForNorthboundAPI`.

In order to receive the information not encrypted in the URL, you will need to connect on the Ruckus SmartZone controller using SSH and do the following command:

 no encrypt-mac-ip


==== PacketFence configuration

In PacketFence, add a new switch in _Configuration -> Switches_ with the following configuration:

* *Definition -> External Portal Enforcement* should be enabled
* *Definition -> Type*: `Ruckus SmartZone Wireless Controller`
* *Definition -> Mode*: `production`
* *Roles -> Role by VLAN ID* should be enabled
* *Roles -> registration VLAN*: `-1`
* *Roles -> Role by Switch Role* should be disabled
* *RADIUS -> Secret passphrase*: `useStrongerSecret`
* *Web Services -> Password*: `passwordForNorthboundAPI`

=== Trapeze

In order to have the Trapeze controller working with PacketFence, you need to define the RADIUS configuration and the proper service profiles.

[float]
==== RADIUS configuration

  set radius server PF address 192.168.1.5 timeout 5 retransmit 3 deadtime 0 key secret
  set server group PF-RADIUS members PF

[float]
==== Service Profiles

Here we define two service profiles, one for the open SSID (PacketFence-Public)
and one for the WPA2-Enterprise SSID (PacketFence-Secure):

----
set service-profile PF-Open ssid-name PacketFence-Public
set service-profile PF-Open ssid-type clear
set service-profile PF-Open auth-fallthru last-resort
set service-profile PF-Open cipher-tkip enable
set service-profile PF-Open auth-dot1x disable
set service-profile PF-Open 11n mode-na required
set service-profile PF-Open attr vlan-name WLAN_REG

set service-profile PF-Secure ssid-name PacketFence-Secure
set service-profile PF-Secure cipher-tkip enable
set service-profile PF-Secure cipher-ccmp enable
set service-profile PF-Secure wpa-ie enable
set service-profile PF-Secure rsn-ie enable
set service-profile PF-Secure 11n mode-na required
set service-profile PF-Secure attr vlan-name Wlan

set radio-profile default service-profile PacketFence-Public
set radio-profile default service-profile PacketFence-Secure
----

[float]
==== AAA configuration

Finally, we need to tie the service profiles with the proper AAA configuration.

  set accounting dot1x ssid PacketFence-Secure ** start-stop PF-RADIUS
  set accounting mac ssid PacketFence-Public * start-stop PF-RADIUS
  set authentication mac ssid PacketFence-Public * PF-RADIUS
  set authentication dot1x ssid PacketFence-Secure ** pass-through PF-RADIUS

=== Ubiquiti

==== Web Authentication

===== Unifi side

In order to configure web authentication (external captive-portal) on Ubiquiti access points, you must have access to a Unifi controller and your APs must be connected to it.

First, you must configure the guest policy. Go in _Settings -> hotspot -> general_ and configure it as shown below:

image::ubiquiti-unifi-guest-policy.png[scaledwidth="100%",alt="Unifi web-auth policy"]

Next, you must allow the device to reach the portal. Go in _Settings -> hotspot -> advanced_ and configure it as shown below:

image::ubiquiti-unifi-guest-policy_access.png[scaledwidth="100%",alt="Unifi web-auth policy"]

Make sure you enabled _Enable Guest Portal_, and that you've set _External portal server_.

You also need to enter the IP address of a portal enabled interface on the PacketFence server in _Custom Portal_. Then in the _ACCESS CONTROL_ section, add that same IP address to the _Pre-Authorization Access_

Then, still in the settings, create or edit a new SSID with the following settings:

image::ubiquiti-unifi-guest-ssid.png[scaledwidth="100%",alt="Unifi web-auth SSID"]

You need to ensure link:https://help.ubnt.com/hc/en-us/articles/115015457668-UniFi-Troubleshooting-STUN-Communication-Errors#whatisstun[STUN protocol] is allowed between access points and
controller so that controller gets link:https://help.ubnt.com/hc/en-us/articles/204976094#1[instant notifications] from access points. That's important to have a correct deauthentication mechanism.

===== PacketFence side

You have two choices to define the APs in PacketFence, by ip address (or range) or by MAC addresses.

By IP address:

If you decide to define the AP by ip then you will need to define the controller as a switch and define the Controller IP and Webservices information (Transport/Username/Password) in his configuration.

Then once done, restart pfcron service and run that to fill the PacketFence cache:

 /usr/local/pf/bin/pfcmd pfcron ubiquiti_ap_mac_to_ip

And verify that you have an entry for each AP

 /usr/local/pf/bin/pfcmd cache switch_distributed list


By MAC address:

Once this is done, you will need to define all your APs MAC addresses in the PacketFence switches with a configuration similar to this:

  [00:11:22:33:44:55]
  description=Ubiquiti AP
  ExternalPortalEnforcement=Y
  type=Ubiquiti::Unifi
  controllerIp=1.2.3.4
  wsTransport=HTTPS
  wsUser=admin
  wsPwd=admin

Where :

[options="compact"]
* *wsTransport* is the protocol used to connect to port 8443 of the Unifi controller and should be HTTPS. This is configured in the 'Web Services' tab of the switch.
* *wsUser* is a valid administrator username on your Unifi controller. This is configured in the 'Web Services' tab of the switch.
* *wsPwd* is the password that is associated to the wsUser. This is configured in the 'Web Services' tab of the switch.
* *controllerIp* is the IP address of your Unifi controller. This is configured in the 'Definition' tab of the switch.

==== VLAN Enforcement


In order to configure VLAN enforcement on the Unifi controller, you need first to configure a RADIUS profile, then a secure wireless network.

Important : You cannot reuse a VLAN ID for dynamic VLAN if it is set as a static value for another SSID on the same AP. So, if you have a SSID set to use VLAN 10, you cannot use VLAN ID 10 for RADIUS controlled VLAN users as those users will not get an IP address.

===== AAA Configuration


image::unifi-radius.png[scaledwidth="100%",alt="Unifi Radius Profile"]

image::unifi-radius2.png[[scaledwidth="100%",alt="Unifi Radius Profile"]

===== Open SSID

Create a open profile:

image::unifi-open.png[scaledwidth="100%",alt="Unifi Open Profile"]

image::unifi-open2.png[[scaledwidth="100%",alt="Unifi Open Profile"]


===== Secure SSID


Create a secured profile:

image::unifi-secure.png[scaledwidth="100%",alt="Unifi Secure SSID"]

image::unifi-secure2.png[scaledwidth="100%",alt="Unifi Secure SSID"]

===== CoA Support

CoA support has been introduced in the new version of the controller (Tested on 5.13.10), so on access reevaluation if you selected RADIUS as disconnect method then PacketFence will try a CoA.

=== Xirrus

==== Xirrus WiFi Arrays

Xirrus Access Points can be configured to work with PacketFence quickly since Xirrus supports RADIUS assigned VLANs out of the box.

First, RADIUS server configuration. Set the RADIUS server to be PacketFence's IP: 

  radius-server  ! (global settings)
    !
    external
      primary     server 192.168.1.5
      primary     secret useStrongerSecret
      !
      accounting
        primary   server 192.168.1.5
        primary   secret useStrongerSecret
      exit
    exit
  exit

Enable SNMP Agent on the access point:

  snmp
    !
    v2
      community read-write public
      community read-only public
    exit
    !
  exit

Finally, don't forget to create the SSID you want and the proper bindings with the LAN. Open SSID should be configured to perform MAC Authentication and Secure SSID should be configured to perform 802.1X (WPA-Enterprise or WPA2-Enterprise).

===== External portal SSID

* Set *Encryption / Authentication* to None / Open
* Then check the WPR checkbox
* Then in in the section Web Page Redirect Configuration set *Server* to External Login
* Set the *Redirect URL* to http://192.168.1.5/Xirrus
* Set the *Redirect Secret* to any passphrase of your choice
* In the *RADIUS Configuration* section set the RADIUS server to point to your PacketFence server

